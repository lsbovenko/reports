{"version":3,"sources":["../../../src/mvc/reports/create.js"],"names":["$","rv","G","formatters","not","value","$date","$form","emptyRecord","isTracked","name","description","workedTime","hours","minutes","datepicker","maxDate","Date","onSelect","dateStr","date","inst","hide","data","formData","durationTooltip","placement","html","title","reports","tracked","untracked","durationPickerOptions","onUpdate","duration","label","parent","find","toggleClass","text","select2Options","tags","width","placeholder","allowClear","controller","addMoreTracked","push","addMoreUntracked","updateTime","e","scope","report","removeReport","deleted","sendNewReport","parsley","isValid","validate","sendData","val","forEach","r","time","ajax","url","method","success","_time","amaran","error","xhr","JSON","parse","responseText","window","alert","bind","selectDate","latestProjects","length","project","last","trigger","readmore","maxHeight","moreLink","lessLink","jQuery","rivets","_globals"],"mappings":"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","file":"create.js","sourcesContent":[";(function ($, rv, G) {\r\n\r\n    rv.formatters.not = function (value) {\r\n        return !value;\r\n    };\r\n\r\n    const $date = $('#date'),\r\n        $form = $('#report-form'),\r\n        emptyRecord = (isTracked = false) => {\r\n            return {name: '', description: '', workedTime: {hours: 0, minutes: 0}, isTracked}\r\n        },\r\n        datepicker = $date.datepicker({\r\n            maxDate: new Date(),\r\n            onSelect(dateStr, date, inst) {\r\n                inst.hide();\r\n            }\r\n        }).data('datepicker');\r\n\r\n    let formData = {\r\n        durationTooltip: {\r\n            placement: 'top',\r\n            html: true,\r\n            title: `<ul class=\"list-unstyled text-justify\">\r\n                        <li><b>1 5</b> = 1 час 5 минут</li>\r\n                        <li><b>0105</b> = 1 час 5 минут</li>\r\n                        <li><b>1h5m</b> = 1 час 5 минут</li>\r\n                        <li><b>5m</b> = 5 минут</li>\r\n                        <li><b>0 5</b> = 5 минут</li>                        \r\n                    </ul>`\r\n        },\r\n        reports: {\r\n            tracked: [],\r\n            untracked: []\r\n        },\r\n        durationPickerOptions: {\r\n            onUpdate(duration) {\r\n                let label = $(this)\r\n                    .parent()\r\n                    .parent()\r\n                    .find('label');\r\n\r\n                //make it red if time greater than 8 hours\r\n                label.toggleClass('font-red', (duration.hours * 60 + duration.minutes) > 480);\r\n                label.text('Время (' + duration.hours + 'ч:' + duration.minutes + 'м)');\r\n            }\r\n        },\r\n        select2Options: {\r\n            tags: true,\r\n            width: '100%',\r\n            placeholder: \"Выбрать/Добавить\",\r\n            allowClear: true\r\n        },\r\n        controller: {\r\n            addMoreTracked() {\r\n                formData.reports.tracked.push(emptyRecord(true));\r\n            },\r\n            addMoreUntracked() {\r\n                formData.reports.untracked.push(emptyRecord());\r\n            },\r\n            updateTime(e, scope) {\r\n                scope.report.workedTime = $(this).duration('getFormatted', true);\r\n            },\r\n            removeReport(e, scope) {\r\n                scope.report.deleted = true;\r\n            },\r\n            sendNewReport() {\r\n\r\n                if (!$form.parsley().isValid()) {\r\n                    $form.parsley().validate();\r\n\r\n                    return;\r\n                }\r\n\r\n                let sendData = {reports: [], date: $date.val()};\r\n\r\n                formData.reports.tracked.forEach(function (r) {\r\n                    if (r.deleted) return;\r\n\r\n                    sendData.reports.push({\r\n                        name: r.name,\r\n                        time: r.workedTime,\r\n                        description: r.description,\r\n                        isTracked: 1\r\n                    });\r\n                });\r\n\r\n                formData.reports.untracked.forEach(function (r) {\r\n                    if (r.deleted) return;\r\n\r\n                    sendData.reports.push({\r\n                        name: r.name,\r\n                        time: r.workedTime,\r\n                        description: r.description,\r\n                        isTracked: 0\r\n                    });\r\n                });\r\n\r\n                $.ajax({\r\n                    url: '/reports/store',\r\n                    method: 'POST',\r\n                    data: sendData,\r\n                    success() {\r\n                        formData.reports.tracked.forEach(function (report) {\r\n                            report.time = {hours: 0, minutes: 0};\r\n                            report._time = '';\r\n                            report.description = '';\r\n                        });\r\n\r\n                        formData.reports.untracked = [];\r\n\r\n                        $.amaran({\r\n                            'message': 'Данные были отправлены.',\r\n                            'position': 'bottom right'\r\n                        });\r\n                    },\r\n\r\n                    error(xhr) {\r\n                        const data = JSON.parse(xhr.responseText);\r\n                        if (data && data.error) {\r\n                            window.alert(data.error);\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        }\r\n    };\r\n\r\n    rv.bind($form, formData);\r\n    datepicker.selectDate(new Date()); //select current date by default\r\n\r\n    /* Select default projects if exist */\r\n    if (G.latestProjects && G.latestProjects.length) {\r\n        G.latestProjects.forEach(function (project) {\r\n            formData.reports.tracked.push(emptyRecord(true));\r\n            $('select.tracked').last().val(project.name).trigger('change');\r\n        });\r\n    }\r\n\r\n    $('.readmore').readmore({\r\n        maxHeight: 0,\r\n        moreLink: '<a href=\"#\">Показать</a>',\r\n        lessLink: '<a href=\"#\">Скрыть</a>'\r\n    });\r\n\r\n})(jQuery, rivets, _globals || {});"]}