{"version":3,"sources":["../../../src/mvc/statistics/index.js"],"names":["$","Vue","G","$date","$datepickerRange","datepicker","maxDate","Date","minDate","inline","onSelect","dateStr","datesArray","inst","opts","range","selectedDates","length","app","filterParams","dates","data","nounEnding","number","endingArray","ending","i","formatMinutes","minutes","hours","parseInt","users","forEach","u","isActive","stats","el","statistics","user_id","methods","fullName","user","last_name","name","inArray","needle","haystack","filterByUser","event","previousActiveUser","id","deleteReport","report","ajax","url","method","success","r","stat","tracked","item","index","splice","untracked","computed","map","d","toString","totalInRange","result","tracked_logged_minutes","untracked_logged_minutes","total","watch","deep","handler","_filterParamsWathcerInit","that","sendData","getFullYear","getMonth","getDate","chartData","chart","update","filters","Chart","type","options","scales","yAxes","ticks","beginAtZero","min","max","stepSize","stacked","xAxes","barPercentage","tooltips","callbacks","label","descriptor","yLabel","toFixed","onClick","evt","getElementAtEvent","_model","clickedDate","selectDate","prop","selectedDate","on","is","jQuery","window","_globals"],"mappings":"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","file":"index.js","sourcesContent":[";(function ($, Vue, G) {\r\n\r\n    const $date = $('#date'),\r\n        $datepickerRange = $('#datepicker-range'),\r\n        datepicker = $date.datepicker({\r\n            maxDate: new Date(),\r\n            minDate: new Date(G.minDate),\r\n            inline: true,\r\n            onSelect(dateStr, datesArray, inst) {\r\n\r\n                if (inst.opts.range && inst.selectedDates.length === 2) {\r\n                    app.filterParams.dates = inst.selectedDates;\r\n                } else if (!inst.opts.range) {\r\n                    app.filterParams.dates = inst.selectedDates;\r\n                }\r\n            }\r\n\r\n        }).data('datepicker'),\r\n        nounEnding = function (number, endingArray) {\r\n            let ending = '';\r\n\r\n            number = number % 100;\r\n            if (number >= 11 && number <= 19) {\r\n                ending = endingArray[2];\r\n            }\r\n            else {\r\n                let i = number % 10;\r\n                switch (i) {\r\n                    case (1):\r\n                        ending = endingArray[0];\r\n                        break;\r\n                    case (2):\r\n                    case (3):\r\n                    case (4):\r\n                        ending = endingArray[1];\r\n                        break;\r\n                    default:\r\n                        ending = endingArray[2];\r\n                }\r\n            }\r\n            return ending;\r\n\r\n        },\r\n        formatMinutes = function (minutes) {\r\n            let hours = parseInt(minutes / 60);\r\n\r\n            minutes = minutes % 60;\r\n\r\n            return hours +\r\n                ' ' +\r\n                nounEnding(hours, ['час', 'часа', 'часов']) +\r\n                ' ' +\r\n                minutes +\r\n                ' ' +\r\n                nounEnding(minutes, ['минута', 'минуты', 'минут']);\r\n        };\r\n\r\n    //add additional properties\r\n    if (G.users) {\r\n        G.users.forEach(u => u.isActive = false);\r\n    }\r\n\r\n\r\n    let stats;\r\n    let app = new Vue({\r\n            el: '#app',\r\n            data: {\r\n                users: G.users || [],\r\n                statistics: stats = G.statistics || [],\r\n                filterParams: {\r\n                    user_id: null,\r\n                    dates: ['']\r\n                }\r\n            },\r\n            methods: {\r\n                fullName(user) {\r\n                    return user.last_name + ' ' + user.name;\r\n                },\r\n                inArray(needle, haystack) {\r\n                    return $.inArray(needle, haystack) !== -1;\r\n                },\r\n                filterByUser(user, event) {\r\n                    if (this.previousActiveUser) {\r\n                        this.previousActiveUser.isActive = false;\r\n                    }\r\n\r\n                    user.isActive = true;\r\n                    this.previousActiveUser = user;\r\n                    this.filterParams.user_id = user.id;\r\n                },\r\n                deleteReport(report)\r\n                {\r\n                    $.ajax({\r\n                        url: '/reports/' + report.id,\r\n                        method: 'DELETE',\r\n                        success(r) {\r\n                            stats.forEach((stat, i) => {\r\n                                if (!stat[i]) {\r\n                                    return ;\r\n                                }\r\n                                stat[i].tracked.forEach((item, index) => {\r\n                                    if (item.id === report.id) {\r\n                                        stat[i].tracked.splice(index, 1);\r\n                                    }\r\n                                });\r\n                                stat[i].untracked.forEach((item, index) => {\r\n                                    if (item.id === report.id) {\r\n                                        stat[i].untracked.splice(index, 1);\r\n                                    }\r\n                                });\r\n                            });\r\n                        }\r\n                    });\r\n                }\r\n            },\r\n            computed: {\r\n                selectedDates(){\r\n                    return this.filterParams.dates.map(d => d.toString());\r\n                },\r\n                totalInRange(){\r\n                    let result = {tracked: 0, untracked: 0};\r\n\r\n                    this.statistics.forEach(stats => {\r\n                        stats.forEach(stat => {\r\n                            result.tracked += stat.tracked_logged_minutes;\r\n                            result.untracked += stat.untracked_logged_minutes;\r\n                        });\r\n\r\n                    });\r\n\r\n                    return {\r\n                        tracked: formatMinutes(result.tracked),\r\n                        untracked: formatMinutes(result.untracked),\r\n                        total: formatMinutes(result.tracked + result.untracked)\r\n                    };\r\n                }\r\n            },\r\n            watch: {\r\n                filterParams: {\r\n                    deep: true,\r\n                    handler() {\r\n                        //prevent from very first run\r\n                        if (!this._filterParamsWathcerInit) {\r\n                            this._filterParamsWathcerInit = true;\r\n                            return;\r\n                        }\r\n\r\n                        let that = this,\r\n                            sendData = {\r\n                                user_id: this.filterParams.user_id,\r\n                                dates: this.filterParams.dates.map(d => d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate())\r\n                            };\r\n\r\n                        $.ajax({\r\n                            url: '/statistics/filter',\r\n                            data: sendData,\r\n                            success(statistics) {\r\n                                that.statistics = statistics;\r\n\r\n                            }\r\n                        });\r\n\r\n                        // if user is selected then we have to visualize data with chart\r\n                        // thus we need to obtain corresponding data\r\n                        if (this.filterParams.user_id) {\r\n                            $.ajax({\r\n                                url: '/statistics/chart-data',\r\n                                data: sendData,\r\n                                success(chartData) {\r\n                                    chart.data = chartData;\r\n                                    chart.update();\r\n                                }\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            filters: {\r\n                formatMinutes\r\n            }\r\n        }),\r\n        chart = new Chart($('#chart'), {\r\n            type: 'bar',\r\n            data: {},\r\n            options: {\r\n                scales: {\r\n                    yAxes: [{\r\n                        ticks: {\r\n                            beginAtZero: true,\r\n                            min: 0,\r\n                            max: 15,\r\n                            stepSize: 1\r\n                        },\r\n                        stacked: true\r\n                    }],\r\n                    xAxes: [{\r\n                        stacked: true,\r\n                        barPercentage: 0.7\r\n                    }]\r\n                },\r\n                tooltips: {\r\n                    callbacks: {\r\n                        label(descriptor){\r\n                            return formatMinutes((descriptor.yLabel * 60).toFixed(2));\r\n                        }\r\n                    }\r\n                },\r\n                onClick(evt) {\r\n                    if (!chart.getElementAtEvent(evt).length) return;\r\n\r\n                    let label = chart.getElementAtEvent(evt)[0]._model.label,\r\n                        clickedDate = new Date(label + '/' + (new Date()).getFullYear());\r\n\r\n                    // disable range mode and select clicked date\r\n                    datepicker.update('range', false);\r\n                    datepicker.selectDate(clickedDate);\r\n                    $datepickerRange.prop('checked', false);\r\n                }\r\n            }\r\n        });\r\n\r\n    datepicker.selectDate(new Date(G.selectedDate)); //select current date by default\r\n\r\n    $datepickerRange.on('change', function () {\r\n        datepicker.update('range', $(this).is(':checked'));\r\n    });\r\n\r\n})(jQuery, Vue, window._globals || {});"]}